import { CalendarModel, Column, DateHelper, ProjectModelConfig, ResourceModel, SchedulerPro, StringHelper } from '@bryntum/schedulerpro';
import { BryntumGridProps, BryntumSchedulerProProps } from '@bryntum/schedulerpro-react';

import { Appointment } from './lib/Appointment';
import { Doctor } from './lib/Doctor';

export const projectConfig: ProjectModelConfig = {
    autoLoad      : true,
    loadUrl       : './data/homecare-complete.json',
    resourceStore : {
        modelClass : Doctor,
        sorters    : [
            { field : 'name', ascending : true }
        ]
    },
    eventStore : {
        // Unassigned events should remain in store
        removeUnassignedEvent : false,
        modelClass            : Appointment
    },
    // This config enables response validation and dumping of found errors to the browser console.
    // It's meant to be used as a development stage helper only so please set it to false for production systems.
    validateResponse : true
};

export const schedulerProps: BryntumSchedulerProProps = {
    startDate           : new Date(2025, 11, 4, 7),
    endDate             : new Date(2025, 11, 4, 20),
    rowHeight           : 95,
    barMargin           : 10,
    eventStyle          : 'bordered',
    eventColor          : 'blue',
    allowOverlap        : false,
    useInitialAnimation : false,
    resourceImagePath   : 'users/',
    infiniteScroll      : true,
    zoomOnTimeAxisDoubleClick : true,
    zoomOnMouseWheel    : true,
    columns             : [
        {
            type           : 'resourceInfo',
            field          : 'name',
            text           : 'Medarbetare',
            width          : 280,
            showEventCount : false,
            showImage      : true,
            imagePath      : 'users/',
            showMeta       : resourceRecord => {
                const doctor = resourceRecord as Doctor;
                const transportIcons = {
                    'Bil': 'ðŸš—',
                    'Cykel': 'ðŸš´',
                    'Promenad': 'ðŸš¶',
                    'Kollektivtrafik': 'ðŸšŒ'
                };
                const transportIcon = transportIcons[doctor.transportMode as keyof typeof transportIcons] || 'ðŸš—';
                return `
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                        <div><i class="${doctor.roleIconCls}"></i> ${doctor.role}</div>
                        <div style="display: flex; gap: 8px; font-size: 11px; flex-wrap: wrap;">
                            <span style="background: #dbeafe; padding: 2px 8px; border-radius: 4px; color: #1e40af; white-space: nowrap;">${doctor.contractType}</span>
                            <span style="background: #fef3c7; padding: 2px 8px; border-radius: 4px; color: #92400e; white-space: nowrap;">${transportIcon} ${doctor.transportMode}</span>
                        </div>
                    </div>
                `;
            }
        },
        {
            type       : 'column',
            text       : 'Arbetstid',
            editor     : false,
            filterable : false,
            sortable   : false,
            width      : 110,
            align      : 'center',
            renderer   : ({ record, grid }) => {
                const
                    scheduler = grid as SchedulerPro,
                    calendar  = (record as ResourceModel)?.calendar as CalendarModel,
                    ranges    = calendar?.getWorkingTimeRanges?.(scheduler.startDate, scheduler.endDate);
                if (ranges?.length) {
                    const range = ranges[0];
                    return `${DateHelper.format(range.startDate, 'HH:mm')} - ${DateHelper.format(range.endDate, 'HH:mm')}`;
                }
                else {
                    return 'â€”';
                }
            }
        }
    ],

    // Custom view preset with header configuration
    viewPreset : {
        base           : 'hourAndDay',
        columnLinesFor : 1,
        headers        : [
            {
                unit       : 'd',
                align      : 'center',
                dateFormat : 'dddd'
            },
            {
                unit       : 'h',
                align      : 'center',
                dateFormat : 'HH'
            }
        ]
    },

    stripeFeature      : true,
    columnLinesFeature : true,
    filterBarFeature   : false, // Disabled - we use custom filter buttons instead
    // Enable ALL SchedulerPro features for MVP
    resourceHistogramFeature : {
        showBarTip : true,
        showBarText : true
    },
    resourceTimeRangesFeature : true,
    nonWorkingTimeFeature : true,
    dependenciesFeature : true,
    constraintsFeature : true,
    undoFeature : true,
    pdfExportFeature : true,
    excelExporterFeature : true,
    printFeature : true,
    regionResizeFeature : true,
    timeRangesFeature : true,
    eventCopyPasteFeature : true,
    cellEditFeature : true,
    cellMenuFeature : true,
    headerMenuFeature : true,
    sortFeature : true,
    searchFeature : true,
    quickFindFeature : true,
    calendarHighlightFeature : {
        calendar : 'resource',
        // This method is provided to determine which resources are available for one or more eventRecords,
        // in order to highlight the right availability intervals
        collectAvailableResources({ scheduler, eventRecords }) {
            const appointment = eventRecords[0] as Appointment;
            return scheduler.resourceStore.query((doctor: Doctor) => doctor.role === appointment.requiredRole || !appointment.requiredRole) as ResourceModel[];
        }
    },
    eventBufferFeature : {
        // The event buffer time spans are considered as unavailable time (like Bryntum Travel Time example)
        bufferIsUnavailableTime : true,
        showDuration           : true, // Show duration text on buffer
        tooltipTemplate         : ({ duration }: any) => `<i class="fa fa-car"></i> Restid: ${duration}`,
        renderer({ eventRecord, resourceRecord, preambleConfig, postambleConfig }: any) {
            const event = eventRecord as Appointment;
            const resource = resourceRecord as Doctor;
            
            // Get transport icon based on employee's transport mode
            const transportIcons = {
                'Bil': 'fa fa-car',
                'Cykel': 'fa fa-bicycle',
                'Promenad': 'fa fa-walking',
                'Kollektivtrafik': 'fa fa-bus'
            };
            const transportIcon = transportIcons[resource?.transportMode as keyof typeof transportIcons] || 'fa fa-car';
            
            // Access preamble from the raw data
            const preambleDuration = event.get ? event.get('preamble') : event.preamble;
            const postambleDuration = event.get ? event.get('postamble') : event.postamble;
            
            if (preambleDuration && preambleDuration > 0) {
                preambleConfig.icon = transportIcon;
                preambleConfig.cls  = event.preambleCls || '';
                // Convert hours to minutes for display
                const minutes = Math.round(preambleDuration * 60);
                preambleConfig.text = `${minutes}min`;
            }
            if (postambleDuration && postambleDuration > 0) {
                postambleConfig.icon = transportIcon;
                postambleConfig.cls  = event.postambleCls || '';
                // Convert hours to minutes for display
                const minutes = Math.round(postambleDuration * 60);
                postambleConfig.text = `${minutes}min`;
            }
        }
    },
    eventTooltipFeature: {
        template: (data: any) => {
            const event = data.eventRecord as Appointment;
            const pinnedBadge = event.pinned ? '<span style="background: #dc2626; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">LÃ…ST</span>' : '';
            const priorityColor = event.priority === 'HÃ¶g' ? '#dc2626' : event.priority === 'LÃ¥g' ? '#6b7280' : '#3b82f6';
            const mapboxToken = 'pk.eyJ1IjoiYmpvcm5jYWlyZSIsImEiOiJjbWNudGs5c3MwMHM4Mm9xdnQ1Z3dxaXJ4In0.GFAAu1PoH7fk7EnmQI95lQ';
            
            // Generate map HTML if coordinates are available (like Bryntum Travel Time example with Leaflet)
            const mapHtml = event.lat && event.lng ? `
                <div style="flex: 1; min-width: 200px;">
                    <img 
                        src="https://api.mapbox.com/styles/v1/mapbox/streets-v11/static/pin-s-marker+3b82f6(${event.lng},${event.lat})/${event.lng},${event.lat},14,0/250x200@2x?access_token=${mapboxToken}"
                        alt="Karta"
                        style="width: 100%; height: 200px; object-fit: cover; border-radius: 6px; border: 1px solid #e5e7eb;"
                    />
                </div>
            ` : '';
            
            return `
                <div style="display: flex; flex-direction: column; min-width: 400px; max-width: 500px;">
                    <header style="display: flex; align-items: center; margin-bottom: 12px;">
                        ${event.patient ? `<div style="font-weight: 700; font-size: 16px; color: #1f2937;">${event.patient}</div>` : ''}
                    </header>
                    <div style="display: flex; gap: 16px;">
                        <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                            <div style="font-weight: 700; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                <i class="fa fa-calendar" style="color: #6b7280;"></i>
                                ${event.name}
                                ${pinnedBadge}
                            </div>
                            <div style="font-size: 12px; color: #6b7280;">
                                ${DateHelper.format(event.startDate, 'LT')} - ${DateHelper.format(event.endDate, 'LT')}
                            </div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 8px;">
                                <strong><i class="fa fa-map-marker-alt" style="margin-right: 6px;"></i>Adress</strong><br/>
                                ${event.address || 'Ingen adress'}
                            </div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 8px;">
                                <strong><i class="fa fa-car" style="margin-right: 6px;"></i>Restid</strong><br/>
                                ${event.preamble ? `<span>${event.preamble}min <i class="fa fa-arrow-right"></i></span>` : '<span>-</span>'}<br/>
                                ${event.postamble ? `<span>${event.postamble}min <i class="fa fa-arrow-left"></i></span>` : '<span>-</span>'}
                            </div>
                            <div style="font-size: 12px; margin-top: 8px;">
                                <strong>Varaktighet:</strong> ${Math.round(event.duration * 60)} min<br/>
                                <strong>Kompetens:</strong> ${event.requiredRole}<br/>
                                <strong style="color: ${priorityColor};">Prioritet:</strong> <span style="color: ${priorityColor};">${event.priority || 'Normal'}</span>
                            </div>
                        </div>
                        ${mapHtml}
                    </div>
                </div>
            `;
        }
    },
    // Configure event menu items with correct phrases (could also be done through localization)
    eventMenuFeature : {
        items : {
            deleteEvent : {
                text : 'Ta bort besÃ¶k'
            },
            unassignEvent : {
                text : 'Avboka besÃ¶k (flytta till oplanerade)'
            },
            togglePinned : {
                text : 'LÃ¥s/LÃ¥s upp besÃ¶k',
                icon : 'fa fa-lock',
                weight : 100,
                onItem : ({ eventRecord } : any) => {
                    eventRecord.pinned = !eventRecord.pinned;
                    // Trigger re-render
                    eventRecord.stores[0].trigger('update', { record: eventRecord });
                }
            }
        }
    },
    eventDragFeature : {
        validatorFn({ eventRecords, newResource, startDate, endDate }) {
            const
                task         = eventRecords[0] as Appointment,
                doctor       = newResource as Doctor,
                { calendar } = doctor,
                valid        = doctor.role === task.requiredRole && (!calendar || (calendar as CalendarModel).isWorkingTime(startDate, endDate)),
                message      = valid ? '' : 'Inget tillgÃ¤ngligt pass';

            return {
                valid,
                message : (valid ? '' : '<i class="b-icon fa-exclamation-triangle"></i>') + message
            };
        }
    },
    taskEditFeature : {
        editorConfig : {
            title : 'Redigera besÃ¶k'
        },

        // Customize its contents inside the General tab
        items : {
            generalTab : {
                // Add a patient field
                items : {
                    // Add a client field
                    orderField : {
                        type   : 'text',
                        name   : 'patient',
                        label  : 'Klient',
                        // Place after name field
                        weight : 150
                    }
                }
            }
        }
    },

    eventRenderer({ eventRecord, renderData }) {
        const appointment = eventRecord as Appointment;
        
        // Apply visitStatus as CSS class (determines background color)
        if (appointment.visitStatus) {
            renderData.cls.add(`visit-status-${appointment.visitStatus}`);
        }
        
        // Build badges for top-right corner
        const badges = [];
        
        // Lock icon
        if (appointment.pinned) {
            badges.push('<i class="fa fa-lock"></i>');
        }
        
        // Staffing icon
        if (appointment.staffingType === 'double') {
            badges.push('<i class="fa fa-users"></i>');
        }
        
        // Recurrence icons with calendar numbers (daily = no icon)
        if (appointment.recurrence === 'weekly') {
            badges.push('<span class="recurrence-badge"><i class="fa fa-calendar"></i>7</span>');
        } else if (appointment.recurrence === 'bi-weekly') {
            badges.push('<span class="recurrence-badge"><i class="fa fa-calendar"></i>14</span>');
        } else if (appointment.recurrence === 'monthly') {
            badges.push('<span class="recurrence-badge"><i class="fa fa-calendar"></i>30</span>');
        }
        
        const badgesHtml = badges.length > 0 
            ? `<div class="event-badges">${badges.map(b => `<span class="badge-icon">${b}</span>`).join('')}</div>`
            : '';
        
        return `
            ${badgesHtml}
            <div class="event-name">${eventRecord.name}</div>
            <div class="event-patient">${appointment.patient || ''}</div>
        `;
    }
};

// Custom grid that holds unassigned visits
export const gridProps: BryntumGridProps = {
    selectionMode : {
        cell : false
    },
    stripeFeature : true,
    sortFeature   : 'name',
    groupFeature  : {
        field : 'requiredRole',
        renderer({ groupRowFor, column }: {
            groupRowFor: string
            column: Column
        }) {
            if (column.parentIndex === 0) {
                return `BesÃ¶k fÃ¶r ${groupRowFor}`;
            }

            return '';
        }
    },
    columns : [
        {
            type    : 'template',
            text    : 'BesÃ¶k',
            flex    : 1,
            cellCls : 'unscheduledNameCell',

            template : ({ record }) => {
                const appointment = record as Appointment;
                return StringHelper.xss`
                        <i class="fa fa-${appointment.iconCls}"></i>
                        <div class="name-container">
                            <span>${StringHelper.encodeHtml(appointment.name)}</span>
                            <span class="patient-name">${appointment.patient}</span>
                        </div>
                    `;
            }
        },
        {
            text  : 'Kompetens',
            field : 'requiredRole'
        }, {
            type     : 'column',
            icon     : 'b-icon fa-clock',
            width    : 80,
            align    : 'center',
            editor   : 'duration',
            field    : 'fullDuration',
            renderer : ({ record }) => {
                const appointment = record as Appointment;
                return `${appointment.duration} ${appointment.durationUnit}`;
            }
        }
    ],

    rowHeight                  : 65,
    disableGridRowModelWarning : true

};
